<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>LAN Drawing Board</title>

<style>
  html, body {
    margin: 0; padding: 0; overflow: hidden;
    font-family: Arial, sans-serif;
    background: #f0f0f0;
    user-select: none;
  }
  #canvasContainer {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 80px;
    background: #fff;
    cursor: crosshair;
    overflow: hidden;
  }
  canvas {
    display: block;
    transform-origin: 0 0;
    image-rendering: pixelated;
    background: #fff;
  }
  #toolbar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 80px;
    background: #fff;
    border-top: 1px solid #ccc;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 6px;
    padding: 6px;
  }
  #paletteContainer {
    display: flex;
    gap: 6px;
  }
  .color {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    border: 2px solid transparent;
    cursor: pointer;
    box-sizing: border-box;
  }
  .color.active {
    border-color: black;
  }
  #brushSize {
    width: 200px;
  }
</style>
</head>
<body>

<div id="canvasContainer">
  <canvas id="canvas" width="3000" height="2000"></canvas>
</div>

<div id="toolbar">
  <div id="paletteContainer"></div>
  <div>
    Brush Size:
    <input type="range" id="brushSize" min="1" max="20" value="1">
  </div>
</div>

<script>
/* === CONFIG === */
const FIREBASE_DB_URL = "https://drawing-ce2f6-default-rtdb.firebaseio.com";

/* === INITIALIZE CANVAS === */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const brushSizeEl = document.getElementById("brushSize");
const paletteContainer = document.getElementById("paletteContainer");
let userIP = "unknown";

/* ===========================
      PALETTE
=========================== */
const colors = [
  "#6D001A","#BE0039","#FF4500","#FFA800","#FFD635","#FFF8B8","#00A368","#00CC78",
  "#7EED56","#00756F","#009EAA","#00CCC0","#2450A4","#3690EA","#51E9F4","#493AC1",
  "#6A5CFF","#811E9F","#B44AC0","#FF3881","#FF99AA","#6D482F","#9C6926","#000000",
  "#898D90","#D4D7D9","#FFFFFF"
];

let currentColor = colors[0];

function drawPalette() {
  paletteContainer.innerHTML = "";
  colors.forEach(c => {
    const div = document.createElement("div");
    div.className = "color" + (c === currentColor ? " active" : "");
    div.style.backgroundColor = c;
    div.addEventListener("click", () => {
      currentColor = c;
      document.querySelectorAll(".color").forEach(el => el.classList.remove("active"));
      div.classList.add("active");
    });
    paletteContainer.appendChild(div);
  });
}
drawPalette();

/* ===========================
      PAN + ZOOM
=========================== */
let scale = 1, tx = 0, ty = 0;
function updateTransform() {
  canvas.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
}
updateTransform();

let isPanning = false;
let panStartX = 0, panStartY = 0, lastTx = 0, lastTy = 0;
let spaceDown = false;

window.addEventListener("keydown", e => {
  if (e.code === "Space") {
    spaceDown = true;
    canvas.style.cursor = "grab";
  }
});
window.addEventListener("keyup", e => {
  if (e.code === "Space") {
    spaceDown = false;
    canvas.style.cursor = "crosshair";
  }
});

canvas.addEventListener("mousedown", e => {
  if (e.button === 2 || spaceDown) {
    isPanning = true;
    panStartX = e.clientX;
    panStartY = e.clientY;
    lastTx = tx;
    lastTy = ty;
    canvas.style.cursor = "grabbing";
  }
});
window.addEventListener("mouseup", () => {
  isPanning = false;
  canvas.style.cursor = spaceDown ? "grab" : "crosshair";
});
window.addEventListener("mousemove", e => {
  if (isPanning) {
    tx = lastTx + (e.clientX - panStartX);
    ty = lastTy + (e.clientY - panStartY);
    updateTransform();
  }
});

canvas.addEventListener("wheel", e => {
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  const factor = e.deltaY > 0 ? 0.9 : 1.1;
  const newScale = Math.min(Math.max(0.1, scale * factor), 20);

  tx = mx - (mx - tx) * (newScale / scale);
  ty = my - (my - ty) * (newScale / scale);
  scale = newScale;

  updateTransform();
}, { passive: false });

canvas.addEventListener("contextmenu", e => e.preventDefault());

/* ===========================
      IP LOGGING (ONCE)
=========================== */
async function fetchIP() {
  try {
    const r = await fetch("https://api.ipify.org?format=json");
    const j = await r.json();
    userIP = j.ip;
  } catch {}
}
fetchIP();

async function ipAlreadyLogged(ip) {
  try {
    const res = await fetch(`${FIREBASE_DB_URL}/ipsLogged/${ip}.json`);
    return await res.json() !== null;
  } catch {
    return false;
  }
}

async function saveIPOnce(ip) {
  try {
    await fetch(`${FIREBASE_DB_URL}/ipsLogged/${ip}.json`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(true)
    });
  } catch {}
}

/* ===========================
      DRAWING TOOL
=========================== */
let drawing = false;

canvas.addEventListener("mousedown", e => {
  if (e.button === 0) {
    drawing = true;
    drawAtEvent(e);
  }
});

window.addEventListener("mouseup", () => drawing = false);

canvas.addEventListener("mousemove", e => {
  if (drawing) drawAtEvent(e);
});

function drawAtEvent(e) {
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor((e.clientX - rect.left) / scale);
  const y = Math.floor((e.clientY - rect.top) / scale);
  const size = parseInt(brushSizeEl.value);

  drawBrush(x, y, size, currentColor);
  saveBrushStroke(x, y, size, currentColor);
}

function drawBrush(cx, cy, size, color) {
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.arc(cx, cy, size, 0, Math.PI * 2);
  ctx.fill();
}

async function saveBrushStroke(x, y, size, color) {
  if (!(await ipAlreadyLogged(userIP))) {
    await saveIPOnce(userIP);
  }

  fetch(`${FIREBASE_DB_URL}/draws.json`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      x, y, size, color,
      time: Date.now()
    })
  }).catch(console.error);
}

/* ===========================
      LOAD EXISTING STROKES
=========================== */
async function loadStrokes() {
  try {
    const resp = await fetch(`${FIREBASE_DB_URL}/draws.json`);
    const data = await resp.json();
    if (!data) return;

    Object.values(data).forEach(d => {
      drawBrush(d.x, d.y, d.size, d.color);
    });
  } catch (e) {
    console.error(e);
  }
}

loadStrokes();

/* Sync every 3 seconds */
setInterval(loadStrokes, 3000);

</script>
</body>
</html>
